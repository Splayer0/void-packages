# Template file for 'vesktop'
pkgname=vesktop
version=1.6.4
revision=1
hostmakedepends="git nodejs pnpm pkg-config python3 tar"
makedepends="glib-devel libnotify-devel"
depends="electron35 libnotify glib"
short_desc="Custom Discord client with Vencord integration"
maintainer="Splayer <mynamesplayer@gmail.com>"
license="GPL-3.0-only"
homepage="https://github.com/Vencord/Vesktop"
distfiles="https://github.com/Vencord/Vesktop/archive/refs/tags/v${version}.tar.gz"
checksum=afd5837f884b29db08285a0167ca16a2ebe86747a7496d7590423c575dac6569
do_build() {
    # prevent pnpm from trying to write to read only system dirs
    export PNPM_HOME="${wrksrc}/.pnpm"

    pnpm install --frozen-lockfile
    pnpm buildLibVesktop
    pnpm build
    pnpm package --linux dir
}

do_install() {
    vmkdir usr/lib/vesktop
    vcopy dist/linux-unpacked/resources/* usr/lib/vesktop/    
    vmkdir usr/share/applications

    cat > ${DESTDIR}/usr/share/applications/vesktop.desktop <<EOF
[Desktop Entry]
Name=Vesktop
Comment=Custom Discord client with Vencord integrated
GenericName=Internet Messenger
Exec=vesktop %U
Icon=vesktop
Type=Application
StartupNotify=true
Categories=Network;InstantMessaging;Chat;
EOF

    vinstall build/icon.svg 644 usr/share/pixmaps vesktop.svg

    # startup script
    vmkdir usr/bin
    cat > ${DESTDIR}/usr/bin/vesktop <<EOF
#!/bin/sh
exec electron35 /usr/lib/vesktop/app.asar "\$@"
EOF
    chmod 755 ${DESTDIR}/usr/bin/vesktop
}
